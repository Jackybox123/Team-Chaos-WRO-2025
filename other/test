import cv2
import numpy as np
from donkeycar.parts.camera import PiCamera

# Initialize the PiCamera (Donkey Car way)
camera = PiCamera()

# Preprocess image function
def preprocess_image(image):
    # Resize image to a fixed size (e.g., 224x224)
    image_resized = cv2.resize(image, (224, 224))
    
    # Convert to HSV color space (more robust under varying light)
    image_hsv = cv2.cvtColor(image_resized, cv2.COLOR_BGR2HSV)
    
    # Normalize image (optional, but helpful for machine learning models)
    image_normalized = image_hsv / 255.0
    
    # Apply histogram equalization to improve contrast
    image_gray = cv2.cvtColor(image_normalized, cv2.COLOR_BGR2GRAY)
    image_equalized = cv2.equalizeHist(image_gray)
    
    # Denoise image to remove noise (optional)
    image_denoised = cv2.GaussianBlur(image_equalized, (5, 5), 0)
    
    return image_denoised

# Main function to process the video stream
def main():
    while True:
        # Capture an image from the PiCamera
        frame = camera.capture()

        # Preprocess the captured image
        preprocessed_frame = preprocess_image(frame)

        # Display the processed image using OpenCV
        cv2.imshow("Processed Image", preprocessed_frame)

        # Exit if 'q' is pressed
        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

    # Release resources when done
    cv2.destroyAllWindows()

if __name__ == "__main__":
    main()
